name: ğŸ§ª Test Universal Standardizer

on:
  workflow_dispatch:  # Manual trigger only

permissions:
  contents: write

jobs:
  test-universal-standardizer:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: ğŸ“‹ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: ğŸ” Check Files Before Processing
      run: |
        echo "=== CHECKING SUPPLIER FILES ==="
        ls -la suppliers/*.json
        echo "=== CHECKING MODULES ==="
        ls -la modules/*.js
        
    - name: ğŸš€ Run Universal Standardizer
      run: node scripts/universal-standardizer.js
      
    - name: âœ… Check Universal Standardizer Results
      run: |
        echo "=== CHECKING UNIVERSAL OUTPUT ==="
        ls -la standardization-UNIVERSAL.json
        echo "File size:" $(wc -c < standardization-UNIVERSAL.json)
        
        echo "=== UNIVERSAL DATA CHECK ==="
        echo "Total matches:" $(jq '.summary.after_processing.total' standardization-UNIVERSAL.json)
        echo "Tom matches:" $(jq '.summary.after_processing.tom' standardization-UNIVERSAL.json)
        echo "Sarah matches:" $(jq '.summary.after_processing.sarah' standardization-UNIVERSAL.json)
        echo "Wendy matches:" $(jq '.summary.after_processing.wendy' standardization-UNIVERSAL.json)
        
        echo "=== DATA LOSS CHECK ==="
        echo "Total data loss:" $(jq '.summary.data_loss.total_loss' standardization-UNIVERSAL.json)
        
    - name: ğŸ’¾ Commit Universal Results
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add standardization-UNIVERSAL.json
        
        if git diff --staged --quiet; then
          echo "ğŸ“ No changes to commit"
        else
          echo "ğŸ“ Changes detected - committing..."
          git commit -m "ğŸ§ª test: Universal standardizer results [automated]"
          git push
          echo "âœ… Results committed!"
        fi
        
    - name: ğŸ¯ Final Report
      run: |
        echo "=== UNIVERSAL STANDARDIZER TEST COMPLETE ==="
        echo "ğŸ“ Output: standardization-UNIVERSAL.json"
        echo "ğŸ”§ Ready for 20+ suppliers with field mapping"
        echo "âœ… Check data loss report in the file"
