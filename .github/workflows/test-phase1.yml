name: ğŸ§ª Test Universal Pipeline

on:
  workflow_dispatch:  # Manual trigger only

permissions:
  contents: write

jobs:
  test-universal-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: ğŸ“‹ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: ğŸ” Check Files Before Processing
      run: |
        echo "=== CHECKING SUPPLIER FILES ==="
        ls -la suppliers/*.json
        echo "=== CHECKING MODULES ==="
        ls -la modules/*.js
        
    - name: ğŸš€ PHASE 1: Run Universal Standardizer
      run: node scripts/universal-standardizer.js
      
    - name: âœ… Check Phase 1 Results
      run: |
        echo "=== PHASE 1 OUTPUT ==="
        ls -la standardization-UNIVERSAL.json
        echo "File size:" $(wc -c < standardization-UNIVERSAL.json)
        echo "Total matches:" $(jq '.summary.after_processing.total' standardization-UNIVERSAL.json)
        echo "Data loss:" $(jq '.summary.data_loss.total_loss' standardization-UNIVERSAL.json)
        
    - name: ğŸš€ PHASE 2: Run Advanced Processor
      run: node scripts/phase2-processor.js
      
    - name: âœ… Check Phase 2 Results
      run: |
        echo "=== PHASE 2 OUTPUT ==="
        ls -la master-data.json
        echo "File size:" $(wc -c < master-data.json)
        echo "Final matches:" $(jq '.summary.total_matches' master-data.json)
        echo "Merged matches:" $(jq '.summary.merged_matches' master-data.json)
        echo "Compression ratio:" $(jq '.summary.compression_ratio' master-data.json)
        
        echo "=== WENDY STREAMS CHECK ==="
        echo "Wendy sources in final data:" $(jq '.matches[] | select(.sources.wendy != null) | .sources.wendy | length' master-data.json | grep -v "0" | wc -l)
        
    - name: ğŸ“Š Compare Pipeline Results
      run: |
        echo "=== PIPELINE COMPARISON ==="
        echo "Phase 1 input:" $(jq '.summary.before_processing.total' standardization-UNIVERSAL.json)
        echo "Phase 1 output:" $(jq '.summary.after_processing.total' standardization-UNIVERSAL.json)
        echo "Phase 2 output:" $(jq '.summary.total_matches' master-data.json)
        echo "Total compression:" $(jq '.summary.compression_ratio' master-data.json)
        
    - name: ğŸ’¾ Commit Pipeline Results
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add standardization-UNIVERSAL.json master-data.json
        
        if git diff --staged --quiet; then
          echo "ğŸ“ No changes to commit"
        else
          echo "ğŸ“ Changes detected - committing..."
          git commit -m "ğŸ§ª test: Universal pipeline results [automated]"
          git push
          echo "âœ… Results committed!"
        fi
        
    - name: ğŸ¯ Final Pipeline Report
      run: |
        echo "=== UNIVERSAL PIPELINE TEST COMPLETE ==="
        echo "ğŸ“ Phase 1: standardization-UNIVERSAL.json"
        echo "ğŸ“ Phase 2: master-data.json"
        echo "ğŸ”§ Ready for production use"
        echo "âœ… Check compression ratio and Wendy streams"
