name: ğŸ§ª Test Phase 1 Standardization

on:
  workflow_dispatch:  # Manual trigger only

permissions:
  contents: write

jobs:
  test-phase1:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: ğŸ“‹ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ” Check Files Before Processing
      run: |
        echo "=== CHECKING SUPPLIER FILES ==="
        ls -la suppliers/*.json
        echo "Tom file size:" $(wc -c < suppliers/tom-data.json)
        echo "Sarah file size:" $(wc -c < suppliers/sarah-data.json) 
        echo "Wendy file size:" $(wc -c < suppliers/wendy-data.json)
        
    - name: ğŸš€ Run Phase 1 Standardization
      run: node scripts/phase1-standardizer.js
      
    - name: âœ… Check Phase 1 Results
      run: |
        echo "=== CHECKING PHASE 1 OUTPUT ==="
        ls -la standardization-TEST.json
        echo "File size:" $(wc -c < standardization-TEST.json)
        
        echo "=== QUICK DATA CHECK ==="
        echo "Total matches:" $(jq '.summary.total_matches' standardization-TEST.json)
        echo "Tom matches:" $(jq '.summary.tom_matches' standardization-TEST.json)
        echo "Sarah matches:" $(jq '.summary.sarah_matches' standardization-TEST.json)
        echo "Wendy matches:" $(jq '.summary.wendy_matches' standardization-TEST.json)
        
        echo "=== WENDY STREAMS CHECK ==="
        jq '.matches[] | select(.source == "wendy") | .sources.wendy | length' standardization-TEST.json | head -5
        echo "Wendy matches with streams:" $(jq '.matches[] | select(.source == "wendy") | .sources.wendy | length' standardization-TEST.json | grep -v "0" | wc -l)
        
    - name: ğŸ“Š Compare with Current System
      run: |
        echo "=== COMPARISON WITH CURRENT SYSTEM ==="
        if [ -f "master-data.json" ]; then
          echo "Current master matches:" $(jq '.matches | length' master-data.json)
          echo "Current Wendy streams found:" $(grep -c "spiderembed" master-data.json || echo "0")
        else
          echo "No master-data.json found for comparison"
        fi
        
        echo "=== PHASE 1 WENDY STREAMS ==="
        grep -c "spiderembed" standardization-TEST.json || echo "0"
        
    - name: ğŸ’¾ Commit Test Results
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add standardization-TEST.json
        
        if git diff --staged --quiet; then
          echo "ğŸ“ No changes to commit"
        else
          echo "ğŸ“ Changes detected - committing..."
          git commit -m "ğŸ§ª test: Phase 1 standardization results [automated]"
          git push
          echo "âœ… Results committed!"
        fi
        
    - name: ğŸ¯ Final Report
      run: |
        echo "=== PHASE 1 TEST COMPLETE ==="
        echo "ğŸ“ Output: standardization-TEST.json"
        echo "ğŸ”§ Check the file for standardized data"
        echo "âœ… Compare Wendy streams with current system"
