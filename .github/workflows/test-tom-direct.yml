name: üîç Test Tom Raw

on:
  workflow_dispatch:

jobs:
  test-tom-raw:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v3
      
    - name: üß™ Install jq
      run: sudo apt-get install -y jq
        
    - name: üöÄ Test Tom API Direct
      run: |
        echo "=== TOM API DIRECT TEST ==="
        echo ""
        
        # 1. Fetch directly from Tom API
        echo "1Ô∏è‚É£ Fetching from: https://topembed.pw/api.php?format=json"
        curl -s "https://topembed.pw/api.php?format=json" > tom-direct-raw.json
        
        # 2. Check file
        echo "   File size: $(wc -c < tom-direct-raw.json) bytes"
        
        # 3. Validate JSON
        echo ""
        echo "2Ô∏è‚É£ Validating JSON..."
        if jq empty tom-direct-raw.json 2>/dev/null; then
          echo "   ‚úÖ Valid JSON"
        else
          echo "   ‚ùå Invalid JSON!"
          exit 1
        fi
        
        # 4. Show dates
        echo ""
        echo "3Ô∏è‚É£ Event dates found:"
        jq -r '.events | keys[]' tom-direct-raw.json
        
        # 5. Count matches per date
        echo ""
        echo "4Ô∏è‚É£ Matches per date:"
        jq -r '.events | to_entries[] | "   \(.key): \(.value | length) matches"' tom-direct-raw.json
        
        # 6. Total matches
        echo ""
        echo "5Ô∏è‚É£ Total matches:"
        jq '[.events[] | length] | add' tom-direct-raw.json
        
        # 7. Check for "today"
        echo ""
        echo "6Ô∏è‚É£ Checking for 'today':"
        if jq -r '.events | keys[]' tom-direct-raw.json | grep -q "today"; then
          echo "   ‚ùå Found 'today' in API response"
          echo "   This means Tom API changed!"
        else
          echo "   ‚úÖ No 'today' found"
          echo "   Tom API returns proper date strings"
        fi
        
        # 8. Sample match
        echo ""
        echo "7Ô∏è‚É£ Sample match (first date, first match):"
        jq '.events | to_entries[0].value[0] | {match: .match, sport: .sport, timestamp: .unix_timestamp, channels: (.channels | length)}' tom-direct-raw.json
        
        # 9. Save as test file
        echo ""
        echo "8Ô∏è‚É£ Saving as test-tom-data.json..."
        cp tom-direct-raw.json test-tom-data.json
        echo "   ‚úÖ Saved: test-tom-data.json"
        
    - name: üì§ Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: tom-api-test-results
        path: |
          tom-direct-raw.json
          test-tom-data.json
        retention-days: 7
