name: üîç Simple Tom Test

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
    - name: üêõ Run Simple Test
      run: |
        echo "=== SUPER SIMPLE TOM API TEST ==="
        echo "Goal: Compare Direct API vs Your Worker"
        echo ""
        
        # 1. Get direct API data
        echo "1Ô∏è‚É£ FETCHING DIRECT FROM TOM..."
        DIRECT_RESPONSE=$(curl -s -m 10 "https://topembed.pw/api.php?format=json")
        
        # Extract dates and count
        DIRECT_DATES=$(echo "$DIRECT_RESPONSE" | jq -r '.events | keys | join(", ")' 2>/dev/null || echo "ERROR")
        DIRECT_COUNT=$(echo "$DIRECT_RESPONSE" | jq '[.events[] | length] | add' 2>/dev/null || echo "0")
        
        echo "   üìÖ Dates: $DIRECT_DATES"
        echo "   üìä Matches: $DIRECT_COUNT"
        
        # 2. Get worker data
        echo ""
        echo "2Ô∏è‚É£ FETCHING FROM YOUR WORKER..."
        WORKER_RESPONSE=$(curl -s -m 10 "https://9kilos-proxy.mandiyandiyakhonyana.workers.dev/api/tom/all")
        
        # Extract data from worker response
        WORKER_DATA=$(echo "$WORKER_RESPONSE" | jq '.data' 2>/dev/null || echo "{}")
        WORKER_DATES=$(echo "$WORKER_DATA" | jq -r '.events | keys | join(", ")' 2>/dev/null || echo "ERROR")
        WORKER_COUNT=$(echo "$WORKER_DATA" | jq '[.events[] | length] | add' 2>/dev/null || echo "0")
        
        echo "   üìÖ Dates: $WORKER_DATES"
        echo "   üìä Matches: $WORKER_COUNT"
        
        # 3. Compare
        echo ""
        echo "3Ô∏è‚É£ COMPARISON RESULT:"
        echo "   ======================================="
        echo "   | Source        | Dates              |"
        echo "   |---------------|--------------------|"
        printf "   | Direct API   | %-18s |\n" "$DIRECT_DATES"
        printf "   | Your Worker  | %-18s |\n" "$WORKER_DATES"
        echo "   ======================================="
        
        # 4. Show sample data
        echo ""
        echo "4Ô∏è‚É£ SAMPLE DATA (First match from each):"
        echo ""
        echo "   Direct API sample:"
        echo "$DIRECT_RESPONSE" | jq '.events | to_entries[0].value[0] | {match: .match, sport: .sport}' 2>/dev/null || echo "   No sample"
        
        echo ""
        echo "   Worker sample:"
        echo "$WORKER_DATA" | jq '.events | to_entries[0].value[0] | {match: .match, sport: .sport}' 2>/dev/null || echo "   No sample"
        
        # 5. Conclusion
        echo ""
        echo "5Ô∏è‚É£ CONCLUSION:"
        if [ "$DIRECT_DATES" = "$WORKER_DATES" ]; then
          echo "   ‚úÖ DATES MATCH! Worker is correct."
        else
          echo "   ‚ùå DATES DON'T MATCH!"
          echo "   Worker is changing '$DIRECT_DATES' ‚Üí '$WORKER_DATES'"
          echo "   This is the bug we need to fix!"
        fi
