name: ðŸ” Simple Tom API Test

on:
  workflow_dispatch:  # Manual trigger

jobs:
  simple-test:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v3
      
    - name: ðŸ› SIMPLE TOM TEST
      run: |
        echo "=== SIMPLE TOM API TEST ==="
        echo "Goal: Fetch â†’ Save â†’ Count â†’ Compare"
        echo ""
        
        # 1. FETCH DIRECT FROM TOM API
        echo "1ï¸âƒ£ FETCHING DIRECT FROM TOM API..."
        curl -s "https://topembed.pw/api.php?format=json" > tom-direct.json
        
        echo "   File created: tom-direct.json"
        echo "   Size: $(wc -c < tom-direct.json) bytes"
        
        # 2. COUNT MATCHES
        echo ""
        echo "2ï¸âƒ£ COUNTING MATCHES..."
        DIRECT_KEYS=$(jq -r '.events | keys[]' tom-direct.json 2>/dev/null || echo "ERROR")
        DIRECT_COUNT=$(jq '[.events[] | length] | add' tom-direct.json 2>/dev/null || echo "0")
        
        echo "   Dates in direct API: $DIRECT_KEYS"
        echo "   Total matches in direct API: $DIRECT_COUNT"
        
        # 3. FETCH FROM YOUR WORKER
        echo ""
        echo "3ï¸âƒ£ FETCHING FROM YOUR WORKER..."
        curl -s "https://9kilos-proxy.mandiyandiyakhonyana.workers.dev/api/tom/all" > tom-worker.json
        
        echo "   File created: tom-worker.json"
        echo "   Size: $(wc -c < tom-worker.json) bytes"
        
        # 4. COUNT FROM WORKER
        echo ""
        echo "4ï¸âƒ£ COUNTING FROM WORKER..."
        WORKER_DATA=$(jq -r '.data' tom-worker.json 2>/dev/null || echo "{}")
        echo "$WORKER_DATA" > tom-worker-data.json
        
        WORKER_KEYS=$(echo "$WORKER_DATA" | jq -r '.events | keys[]' 2>/dev/null || echo "ERROR")
        WORKER_COUNT=$(echo "$WORKER_DATA" | jq '[.events[] | length] | add' 2>/dev/null || echo "0")
        
        echo "   Dates from worker: $WORKER_KEYS"
        echo "   Total matches from worker: $WORKER_COUNT"
        
        # 5. COMPARE
        echo ""
        echo "5ï¸âƒ£ COMPARISON:"
        echo "   ==========================="
        echo "   | Source  | Dates        | Matches |"
        echo "   |---------|--------------|---------|"
        echo "   | Direct  | $DIRECT_KEYS | $DIRECT_COUNT  |"
        echo "   | Worker  | $WORKER_KEYS | $WORKER_COUNT  |"
        echo "   ==========================="
        
        # 6. CHECK IF SAME
        echo ""
        echo "6ï¸âƒ£ RESULT:"
        if [ "$DIRECT_KEYS" = "$WORKER_KEYS" ] && [ "$DIRECT_COUNT" = "$WORKER_COUNT" ]; then
          echo "   âœ… SAME DATA! Worker is working correctly."
        else
          echo "   âŒ DIFFERENT DATA! Worker is changing something."
          echo "   Differences:"
          echo "   - Dates: Direct='$DIRECT_KEYS' vs Worker='$WORKER_KEYS'"
          echo "   - Count: Direct=$DIRECT_COUNT vs Worker=$WORKER_COUNT"
        fi
        
        # 7. SAVE FILES FOR DOWNLOAD
        echo ""
        echo "7ï¸âƒ£ SAVING FILES..."
        mkdir -p test-results
        cp tom-direct.json test-results/
        cp tom-worker.json test-results/
        cp tom-worker-data.json test-results/
        
        # Create simple report
        cat > test-results/report.txt << EOF
        Tom API Test - $(date)
        ======================
        
        DIRECT API (https://topembed.pw/api.php?format=json):
        - Dates: $DIRECT_KEYS
        - Total matches: $DIRECT_COUNT
        
        YOUR WORKER (https://9kilos-proxy.mandiyandiyakhonyana.workers.dev/api/tom/all):
        - Dates: $WORKER_KEYS  
        - Total matches: $WORKER_COUNT
        
        RESULT: $(if [ "$DIRECT_KEYS" = "$WORKER_KEYS" ] && [ "$DIRECT_COUNT" = "$WORKER_COUNT" ]; then echo "âœ… SAME"; else echo "âŒ DIFFERENT"; fi)
        
        Files:
        - tom-direct.json: Direct API response
        - tom-worker.json: Full worker response  
        - tom-worker-data.json: Just the data part from worker
        EOF
        
        echo "   âœ… Files saved to test-results/"
        
    - name: ðŸ“¤ Upload Results
      uses: actions/upload-artifact@v3
      with:
        name: simple-tom-test
        path: test-results/
        retention-days: 7
