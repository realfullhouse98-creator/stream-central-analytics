name: ğŸ§ª Test Universal Pipeline

on:
  workflow_dispatch:  # Manual trigger only

permissions:
  contents: write

jobs:
  test-universal-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: ğŸ“‹ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: ğŸ” Check Files Before Processing
      run: |
        echo "=== CHECKING SUPPLIER FILES ==="
        ls -la suppliers/*.json
        echo "=== CHECKING MODULES ==="
        ls -la modules/*.js
        echo "=== CHECKING SCRIPTS ==="
        ls -la scripts/*.js
        
    - name: ğŸš€ PHASE 1: Run Universal Standardizer
      run: node scripts/universal-standardizer.js
      
    - name: âœ… Check Phase 1 Results
      run: |
        echo "=== PHASE 1 OUTPUT ==="
        if [ -f "standardization-UNIVERSAL.json" ]; then
          ls -la standardization-UNIVERSAL.json
          echo "File size:" $(wc -c < standardization-UNIVERSAL.json)
          echo "Total matches:" $(jq '.summary.after_processing.total' standardization-UNIVERSAL.json 2>/dev/null || echo "ERROR")
          echo "Data loss:" $(jq '.summary.data_loss.total_loss' standardization-UNIVERSAL.json 2>/dev/null || echo "ERROR")
        else
          echo "âŒ Phase 1 output file not found"
        fi
        
    - name: ğŸš€ PHASE 2: Run Advanced Processor
      run: node scripts/phase2-processor.js
      
    - name: âœ… Check Phase 2 Results
      run: |
        echo "=== PHASE 2 OUTPUT ==="
        if [ -f "master-data.json" ]; then
          ls -la master-data.json
          echo "File size:" $(wc -c < master-data.json)
          echo "Final matches:" $(jq '.summary.total_matches' master-data.json 2>/dev/null || echo "ERROR")
          echo "Merged matches:" $(jq '.summary.merged_matches' master-data.json 2>/dev/null || echo "ERROR")
          echo "Compression ratio:" $(jq '.summary.compression_ratio' master-data.json 2>/dev/null || echo "ERROR")
          
          echo "=== WENDY STREAMS CHECK ==="
          echo "Matches with Wendy streams:" $(jq '[.matches[] | select(.sources.wendy != null and .sources.wendy | length > 0)] | length' master-data.json 2>/dev/null || echo "ERROR")
        else
          echo "âŒ Phase 2 output file not found"
        fi
        
    - name: ğŸ“Š Compare Pipeline Results
      run: |
        echo "=== PIPELINE COMPARISON ==="
        if [ -f "standardization-UNIVERSAL.json" ] && [ -f "master-data.json" ]; then
          PHASE1_INPUT=$(jq '.summary.before_processing.tom + .summary.before_processing.sarah + .summary.before_processing.wendy' standardization-UNIVERSAL.json 2>/dev/null || echo "0")
          PHASE1_OUTPUT=$(jq '.summary.after_processing.total' standardization-UNIVERSAL.json 2>/dev/null || echo "0")
          PHASE2_OUTPUT=$(jq '.summary.total_matches' master-data.json 2>/dev/null || echo "0")
          
          echo "Raw supplier data: $PHASE1_INPUT"
          echo "After standardization: $PHASE1_OUTPUT" 
          echo "After merging: $PHASE2_OUTPUT"
          
          if [ "$PHASE1_INPUT" -gt 0 ] && [ "$PHASE2_OUTPUT" -gt 0 ]; then
            COMPRESSION=$(( (PHASE1_INPUT - PHASE2_OUTPUT) * 100 / PHASE1_INPUT ))
            echo "Total compression: ${COMPRESSION}%"
          fi
        else
          echo "âŒ Missing pipeline files for comparison"
        fi
        
    - name: ğŸ’¾ Commit Pipeline Results
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Only commit if files exist and have content
        if [ -f "standardization-UNIVERSAL.json" ] && [ -f "master-data.json" ]; then
          git add standardization-UNIVERSAL.json master-data.json
          
          if git diff --staged --quiet; then
            echo "ğŸ“ No changes to commit"
          else
            echo "ğŸ“ Changes detected - committing..."
            git commit -m "ğŸ§ª test: Universal pipeline results [automated]"
            git push
            echo "âœ… Results committed!"
          fi
        else
          echo "âŒ Missing output files - skipping commit"
        fi
        
    - name: ğŸ¯ Final Pipeline Report
      run: |
        echo "=== UNIVERSAL PIPELINE TEST COMPLETE ==="
        echo "ğŸ“ Phase 1: standardization-UNIVERSAL.json"
        echo "ğŸ“ Phase 2: master-data.json"
        echo "ğŸ”§ Two-phase processing complete"
        echo "âœ… Check the committed files for results"
