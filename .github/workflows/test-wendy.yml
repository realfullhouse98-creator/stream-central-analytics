name: ğŸ”¬ Test Wendy Integration
on:
  workflow_dispatch:        # Manual trigger only

permissions:
  contents: write

jobs:
  test-wendy:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ”„ Update Wendy Data
      run: |
        echo "=== UPDATING WENDY DATA ==="
        node scripts/update-suppliers.js
        
        echo "=== WENDY DATA VERIFICATION ==="
        echo "Wendy records:" $(jq '.matches | length' suppliers/wendy-data.json)
        echo "Wendy streams:" $(jq '[.matches[] | select(.streams and .streams.length > 0)] | length' suppliers/wendy-data.json)
        
    - name: ğŸ¯ Process Wendy-Only Data
      run: |
        echo "=== PROCESSING WENDY-ONLY DATA ==="
        node scripts/simple-wendy-processor.js
        
        echo "=== WENDY MASTER VERIFICATION ==="
        echo "Master Wendy file size:" $(wc -c < master-wendy.json)
        echo "Master Wendy matches:" $(jq '.matches | length' master-wendy.json)
        echo "Master Wendy sports:" $(jq '.summary.sports' master-wendy.json)
        
    - name: ğŸ” Compare Results
      run: |
        echo "=== COMPARISON RESULTS ==="
        
        # Check if master-wendy has data
        WENDY_MASTER_COUNT=$(jq '.matches | length' master-wendy.json 2>/dev/null || echo "0")
        echo "Wendy-only master matches: $WENDY_MASTER_COUNT"
        
        # Check if main master has Wendy data
        MAIN_MASTER_COUNT=$(jq '.matches | length' master-data.json 2>/dev/null || echo "0")
        echo "Main master matches: $MAIN_MASTER_COUNT"
        
        # Check for spiderembed streams in both
        WENDY_STREAMS=$(grep -c "spiderembed" master-wendy.json 2>/dev/null || echo "0")
        MAIN_STREAMS=$(grep -c "spiderembed" master-data.json 2>/dev/null || echo "0")
        echo "Wendy master spiderembed streams: $WENDY_STREAMS"
        echo "Main master spiderembed streams: $MAIN_STREAMS"
        
        # Conclusion
        if [ "$WENDY_MASTER_COUNT" -gt "0" ] && [ "$MAIN_STREAMS" -eq "0" ]; then
          echo "ğŸ¯ CONCLUSION: Wendy processing WORKS but merging FAILS"
        elif [ "$WENDY_MASTER_COUNT" -eq "0" ]; then
          echo "âŒ CONCLUSION: Wendy processing FAILS"
        else
          echo "âœ… CONCLUSION: Wendy processing and merging BOTH WORK"
        fi
        
    - name: ğŸ“ Commit Wendy Test Results
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add test results
        git add master-wendy.json
        
        echo "=== GIT STATUS ==="
        git status
        
        if git diff --staged --quiet; then
          echo "ğŸ“ No Wendy test results to commit"
        else
          echo "ğŸ“ Committing Wendy test results..."
          git commit -m "ğŸ”¬ test: wendy integration test results [automated]"
          git push
          echo "âœ… Wendy test results committed!"
        fi
