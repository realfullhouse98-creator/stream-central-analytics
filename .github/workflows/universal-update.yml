name: Universal Sports Pipeline

on:
  schedule:
    - cron: '*/90 * * * *'  # Every 90 minutes
  workflow_dispatch:  # Manual trigger

jobs:
  process:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install
        
    - name: Create required directories
      run: |
        mkdir -p suppliers/backups
        
    - name: Update suppliers
      run: node scripts/update-suppliers.js
      
    - name: Verify supplier data
      run: |
        echo "=== SUPPLIER FILE SIZES ==="
        ls -lh suppliers/*.json 2>/dev/null || echo "No supplier files found"
        echo "=== CHECK SUPPLIER DATA ==="
        node -e "
          const fs = require('fs');
          try {
            // Check Tom
            if (fs.existsSync('./suppliers/tom-data.json')) {
              const tom = JSON.parse(fs.readFileSync('./suppliers/tom-data.json', 'utf8'));
              const tomCount = tom.matches ? tom.matches.length : 
                              (tom.events ? Object.values(tom.events).flat().length : 0);
              console.log('Tom records:', tomCount);
            } else {
              console.log('Tom records: FILE NOT FOUND');
            }
            
            // Check Sarah
            if (fs.existsSync('./suppliers/sarah-data.json')) {
              const sarah = JSON.parse(fs.readFileSync('./suppliers/sarah-data.json', 'utf8'));
              const sarahCount = sarah.matches ? sarah.matches.length : 0;
              console.log('Sarah records:', sarahCount);
            } else {
              console.log('Sarah records: FILE NOT FOUND');
            }
            
            // Check Wendy
            if (fs.existsSync('./suppliers/wendy-data.json')) {
              const wendy = JSON.parse(fs.readFileSync('./suppliers/wendy-data.json', 'utf8'));
              const wendyCount = wendy.matches ? wendy.matches.length : 0;
              console.log('Wendy records:', wendyCount);
            } else {
              console.log('Wendy records: FILE NOT FOUND');
            }
            
          } catch(e) {
            console.error('Verification failed:', e.message);
          }
        "
        
    - name: Phase 1 - Universal Standardization
      run: node scripts/universal-standardizer.js
      
    - name: Phase 2 - Advanced Processing
      run: node scripts/phase2-processor.js
      
    - name: Final verification
      run: |
        echo "=== FINAL VERIFICATION ==="
        if [ -f "./master-data.json" ]; then
          echo "Master file exists: YES"
          echo "File size: \$(stat -f%z ./master-data.json 2>/dev/null || stat -c%s ./master-data.json)"
          node -e "
            const fs = require('fs');
            try {
              const data = JSON.parse(fs.readFileSync('./master-data.json', 'utf8'));
              console.log('Total matches:', data.matches?.length || 0);
              
              const wendyStreams = data.matches?.filter(m => 
                m.sources?.wendy?.length > 0
              ).length || 0;
              console.log('Wendy streams found:', wendyStreams);
            } catch(e) {
              console.error('Error reading master-data:', e.message);
            }
          "
        else
          echo "Master file exists: NO"
          echo "Looking for files..."
          ls -la *.json
        fi
        
    - name: Commit results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add suppliers/*.json standardization-UNIVERSAL.json master-data.json
        git commit -m "Update sports data \$(date)" || echo "No changes to commit"
        git push
