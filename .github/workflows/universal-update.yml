name: Universal Sports Pipeline

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:  # Manual trigger

jobs:
  process:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install
        
    - name: Create required directories
      run: |
        mkdir -p suppliers/backups
        mkdir -p scripts
        mkdir -p modules
        
    - name: Copy files to correct locations
      run: |
        cp api.js scripts/
        cp update-suppliers.js scripts/
        cp universal-standardizer.js scripts/
        cp phase2-processor.js scripts/
        cp test-suppliers.js scripts/
        cp normalization-map.js modules/
        cp supplier-config.js suppliers/
        
    - name: Update suppliers (Worker-Primary)
      run: node scripts/update-suppliers.js
      
    - name: Verify supplier data
      run: |
        echo "=== SUPPLIER FILE SIZES ==="
        ls -lh suppliers/*.json
        echo "=== CHECK SUPPLIER DATA ==="
        node -e "
          try {
            const tom = JSON.parse(fs.readFileSync('./suppliers/tom-data.json', 'utf8'));
            const sarah = JSON.parse(fs.readFileSync('./suppliers/sarah-data.json', 'utf8'));
            const wendy = JSON.parse(fs.readFileSync('./suppliers/wendy-data.json', 'utf8'));
            
            const tomCount = tom.matches ? tom.matches.length : 
                            (tom.events ? Object.values(tom.events).flat().length : 0);
            const sarahCount = sarah.matches ? sarah.matches.length : 0;
            const wendyCount = wendy.matches ? wendy.matches.length : 0;
            
            console.log('Tom records:', tomCount);
            console.log('Sarah records:', sarahCount);
            console.log('Wendy records:', wendyCount);
            
            if (tomCount + sarahCount + wendyCount < 100) {
              console.error('âŒ INSUFFICIENT DATA');
              process.exit(1);
            }
          } catch(e) {
            console.error('Verification failed:', e.message);
            process.exit(1);
          }
        "
        
    - name: Phase 1 - Universal Standardization
      run: node scripts/universal-standardizer.js
      
    - name: Phase 2 - Advanced Processing
      run: node scripts/phase2-processor.js
      
    - name: Final verification
      run: |
        echo "=== FINAL VERIFICATION ==="
        if [ -f "./master-data.json" ]; then
          echo "Master file exists: YES"
          echo "File size: $(stat -f%z ./master-data.json 2>/dev/null || stat -c%s ./master-data.json)"
          node -e "
            const data = JSON.parse(fs.readFileSync('./master-data.json', 'utf8'));
            console.log('Total matches:', data.matches?.length || 0);
            
            const wendyStreams = data.matches?.filter(m => 
              m.sources?.wendy?.length > 0
            ).length || 0;
            console.log('Wendy streams found:', wendyStreams);
          "
        else
          echo "Master file exists: NO"
          exit 1
        fi
        
    - name: Commit results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add suppliers/*.json standardization-UNIVERSAL.json master-data.json
        git commit -m "Update sports data $(date)" || echo "No changes to commit"
        git push
